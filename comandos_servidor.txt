# COMANDOS PARA EXECUTAR NO SERVIDOR LOCAWEB
# Execute um comando por vez e verifique se funcionou antes do próximo

# 1. PARAR PROCESSOS EXISTENTES
pkill -f "python manage.py runserver"
pkill -f "gunicorn"

# 2. INSTALAR DEPENDÊNCIAS
pip install gunicorn
pip install -r requirements_production.txt

# 3. CRIAR ARQUIVO DE CONFIGURAÇÃO DO NGINX
sudo nano /etc/nginx/sites-available/sistema-estelar

# Cole este conteúdo no arquivo:
# server {
#     listen 80;
#     server_name _;
#     
#     location /static/ {
#         alias /var/www/sistema-estelar/staticfiles/;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#     }
#     
#     location /media/ {
#         alias /var/www/sistema-estelar/media/;
#         expires 1y;
#         add_header Cache-Control "public";
#     }
#     
#     location / {
#         proxy_pass http://127.0.0.1:8000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_redirect off;
#     }
#     
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "no-referrer-when-downgrade" always;
# }

# 4. ATIVAR SITE NO NGINX
sudo ln -s /etc/nginx/sites-available/sistema-estelar /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# 5. TESTAR E REINICIAR NGINX
sudo nginx -t
sudo systemctl restart nginx

# 6. INSTALAR SUPERVISOR (se não estiver instalado)
sudo apt update
sudo apt install -y supervisor

# 7. CRIAR ARQUIVO DE CONFIGURAÇÃO DO SUPERVISOR
sudo nano /etc/supervisor/conf.d/sistema-estelar.conf

# Cole este conteúdo no arquivo:
# [program:sistema-estelar]
# command=/var/www/sistema-estelar/venv/bin/gunicorn --config gunicorn.conf.py sistema_estelar.wsgi_production:application
# directory=/var/www/sistema-estelar
# user=www-data
# autostart=true
# autorestart=true
# redirect_stderr=true
# stdout_logfile=/var/log/supervisor/sistema-estelar.log
# stderr_logfile=/var/log/supervisor/sistema-estelar_error.log

# 8. CONFIGURAR SUPERVISOR
sudo supervisorctl reread
sudo supervisorctl update

# 9. CONFIGURAR PERMISSÕES
sudo chown -R www-data:www-data /var/www/sistema-estelar
sudo chmod -R 755 /var/www/sistema-estelar

# 10. COLETAR ARQUIVOS ESTÁTICOS
python manage.py collectstatic --noinput --settings=sistema_estelar.settings_production

# 11. EXECUTAR MIGRAÇÕES
python manage.py migrate --settings=sistema_estelar.settings_production

# 12. INICIAR APLICAÇÃO
sudo supervisorctl start sistema-estelar

# 13. VERIFICAR STATUS
sudo systemctl status nginx
sudo supervisorctl status sistema-estelar

# 14. TESTAR CONECTIVIDADE
curl http://localhost:8000
curl http://localhost

# 15. VER LOGS (se houver problemas)
sudo tail -f /var/log/supervisor/sistema-estelar.log
sudo tail -f /var/log/nginx/error.log
