{% extends 'base.html' %}

{% block content %}
    <h2>Emitir Romaneio de Viagem</h2>
    <form method="post">
        {% csrf_token %}

        {# Erros gerais do formulário (não vinculados a um campo específico) #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="mb-3">
            <label for="{{ form.cliente.id_for_label }}" class="form-label">Cliente:</label>
            {{ form.cliente }}
            {# Adição do bloco de erro para o campo cliente #}
            {% if form.cliente.errors %}
                <div class="text-danger">
                    {% for error in form.cliente.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label class="form-label">Notas Fiscais Associadas:</label>
            <div id="notas_fiscais_checkboxes">
                {# As checkboxes serão carregadas aqui via JavaScript #}
                {% for checkbox in form.notas_fiscais %}
                    <div>{{ checkbox }}</div>
                {% empty %}
                    <p>Selecione um cliente para carregar as notas fiscais.</p>
                {% endfor %}
            </div>
            {# Adição do bloco de erro para o campo notas_fiscais #}
            {% if form.notas_fiscais.errors %}
                <div class="text-danger">
                    {% for error in form.notas_fiscais.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.motorista.id_for_label }}" class="form-label">Motorista:</label>
            {{ form.motorista }}
            {# Adição do bloco de erro para o campo motorista #}
            {% if form.motorista.errors %}
                <div class="text-danger">
                    {% for error in form.motorista.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.veiculo.id_for_label }}" class="form-label">Veículo:</label>
            {{ form.veiculo }}
            {# Adição do bloco de erro para o campo veiculo #}
            {% if form.veiculo.errors %}
                <div class="text-danger">
                    {% for error in form.veiculo.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações:</label>
            {{ form.observacoes }}
            {# Adição do bloco de erro para o campo observacoes #}
            {% if form.observacoes.errors %}
                <div class="text-danger">
                    {% for error in form.observacoes.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-success">Emitir Romaneio</button>
        <a href="{% url 'notas:listar_romaneios' %}" class="btn btn-secondary">Cancelar</a>
    </form>

    <script>
        // Função JavaScript para carregar notas fiscais via AJAX
        function loadNotasFiscais(clienteId) {
            const notasFiscaisDiv = document.getElementById('notas_fiscais_checkboxes');
            notasFiscaisDiv.innerHTML = '<p>Carregando notas...</p>'; // Mensagem de carregamento

            if (clienteId) {
                fetch(`/notas/ajax/load-notas/?cliente_id=${clienteId}`)
                    .then(response => response.json())
                    .then(data => {
                        notasFiscaisDiv.innerHTML = ''; // Limpa antes de adicionar
                        if (data.length > 0) {
                            data.forEach(nota => {
                                const div = document.createElement('div');
                                const input = document.createElement('input');
                                input.type = 'checkbox';
                                input.name = 'notas_fiscais';
                                input.value = nota.id;
                                input.id = `id_notas_fiscais_${nota.id}`; // Garante ID único
                                input.className = 'form-check-input'; // Para Bootstrap
                                
                                const label = document.createElement('label');
                                label.htmlFor = `id_notas_fiscais_${nota.id}`;
                                label.textContent = nota.nota;
                                label.className = 'form-check-label'; // Para Bootstrap

                                div.appendChild(input);
                                div.appendChild(label);
                                div.className = 'form-check'; // Para Bootstrap
                                notasFiscaisDiv.appendChild(div);
                            });
                        } else {
                            notasFiscaisDiv.innerHTML = '<p>Nenhuma nota fiscal encontrada para este cliente.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar notas fiscais:', error);
                        notasFiscaisDiv.innerHTML = '<p class="text-danger">Erro ao carregar notas fiscais. Tente novamente.</p>';
                    });
            } else {
                notasFiscaisDiv.innerHTML = '<p>Selecione um cliente para carregar as notas fiscais.</p>';
            }
        }

        // Chamar a função loadNotasFiscais quando o cliente for pré-selecionado (para edições ou recarregamentos)
        document.addEventListener('DOMContentLoaded', function() {
            const clienteSelect = document.getElementById('id_cliente');
            if (clienteSelect && clienteSelect.value) {
                loadNotasFiscais(clienteSelect.value);
            }
        });
    </script>
{% endblock %}