{% extends 'base.html' %}

{% block title %}Detalhes do Motorista - {{ motorista.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Detalhes do Motorista: {{ motorista.nome }}</h2>

    {# Mensagens do Django #}
    {% if messages %}
        <ul class="messages list-unstyled">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    {# Dados do Motorista #}
    <div class="card card-body mb-4">
        <h3>Informações Pessoais e CNH</h3>
        <p><strong>Nome Completo:</strong> {{ motorista.nome }}</p>
        <p><strong>CPF:</strong> {{ motorista.cpf }}</p>
        <p><strong>CNH:</strong> {{ motorista.cnh }}</p>
        <p><strong>Código de Segurança CNH:</strong> {{ motorista.codigo_seguranca|default:"N/A" }}</p>
        <p><strong>Vencimento CNH:</strong> {{ motorista.vencimento_cnh|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>UF de Emissão CNH:</strong> {{ motorista.uf_emissao_cnh|default:"N/A" }}</p>
        <p><strong>Data de Nascimento:</strong> {{ motorista.data_nascimento|date:"d/m/Y"|default:"N/A" }}</p>
        <p><strong>Telefone:</strong> {{ motorista.telefone|default:"N/A" }}</p>
    </div>

    <div class="card card-body mb-4">
        <h3>Endereço</h3>
        <p><strong>Endereço:</strong> {{ motorista.endereco|default:"N/A" }}, {{ motorista.numero|default:"S/N" }}</p>
        <p><strong>Complemento:</strong> {{ motorista.complemento|default:"N/A" }}</p>
        <p><strong>Bairro:</strong> {{ motorista.bairro|default:"N/A" }}</p>
        <p><strong>Cidade/Estado:</strong> {{ motorista.cidade|default:"N/A" }}/{{ motorista.estado|default:"N/A" }}</p>
        <p><strong>CEP:</strong> {{ motorista.cep|default:"N/A" }}</p>
    </div>
    
    {# Histórico de Consultas (reaproveita a lógica de exibição do editar_motorista) #}
    <div class="card card-body mt-4">
        <h3>Histórico de Consultas de Risco (Últimas 5)</h3>
        <button type="button" class="btn btn-primary btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#adicionarConsultaModal">Registrar Nova Consulta</button>
        
        {% if historico_consultas %}
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Número da Consulta</th>
                        <th>Data</th>
                        <th>Status</th>
                        <th>Observações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for consulta in historico_consultas %}
                        <tr>
                            <td>{{ consulta.numero_consulta }}</td>
                            <td>{{ consulta.data_consulta|date:"d/m/Y" }}</td>
                            <td>{{ consulta.get_status_consulta_display }}</td>
                            <td>{{ consulta.observacoes|default:"N/A" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Nenhuma consulta de risco registrada para este motorista.</p>
        {% endif %}
    </div>

    {# Botões de Ação: Editar e Excluir #}
    <div class="mt-4">
        <a href="{% url 'notas:editar_motorista' motorista.pk %}" class="btn btn-warning me-2">Editar Motorista</a>
        <form action="{% url 'notas:excluir_motorista' motorista.pk %}" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este motorista?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger me-2">Excluir Motorista</button>
        </form>
        <a href="{% url 'notas:listar_motoristas' %}" class="btn btn-secondary">Voltar à Pesquisa</a>
    </div>

    {# Modal para Adicionar Nova Consulta (Mesmo do editar_motorista.html) #}
    <div class="modal fade" id="adicionarConsultaModal" tabindex="-1" aria-labelledby="adicionarConsultaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adicionarConsultaModalLabel">Registrar Nova Consulta de Risco</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="historicoConsultaForm" method="post" action="{% url 'notas:adicionar_historico_consulta' motorista.pk %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="id_numero_consulta_modal" class="form-label">Número da Consulta:</label>
                            <input type="text" class="form-control" id="id_numero_consulta_modal" name="numero_consulta" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_data_consulta_modal" class="form-label">Data da Consulta:</label>
                            <input type="date" class="form-control" id="id_data_consulta_modal" name="data_consulta" value="{{ 'now'|date:'Y-m-d' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_status_consulta_modal" class="form-label">Status da Consulta:</label>
                            <select class="form-control" id="id_status_consulta_modal" name="status_consulta" required>
                                <option value="Apto">Apto</option>
                                <option value="Inapto">Inapto</option>
                                <option value="Pendente">Pendente</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="id_observacoes_modal" class="form-label">Observações:</label>
                            <textarea class="form-control" id="id_observacoes_modal" name="observacoes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-primary">Salvar Consulta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}